(function(a){function g(){return Backbone.History.apply(this,arguments)}function i(a,b){b=b||{},this.path=a,this.params={},this.regexp=this.pathRegexp(a,this.keys=[],b.sensitive,b.strict)}function j(a){this.params=a||{},this.initialize.apply(this,arguments)}function k(a){this.currentPlace=a,this.initialize.apply(this,arguments)}function l(a,b){this.Place=a,this.Activity=b,this.pattern=a.prototype.pattern}function n(a){this._displayRegion=a,this._matchs=[]}function p(){this._managers=[],this._bindEvents()}var b=this,c;typeof exports!="undefined"?c=exports:c=b.activities={},c.VERSION="0.3.1",!a&&typeof require!="undefined"&&(b.jQuery=a=require("jquery")),!b.Backbone&&typeof require!="undefined"&&(b.Backbone=require("backbone")),!b._&&typeof require!="undefined"&&(b._=require("underscore")._),b.Backbone.activities=c,c.helpers={};var d=function(a){var b=a.prototype.place;if(!b)throw new Error("Activity must have a `place` property");return _.isArray(b)?b:[b]},e=function(a){return _.isArray(a)};c.helpers.extend=Backbone.View.extend,c.helpers.getPlaces=d,c.helpers.resolvedPromise=null;var f={};_.extend(f,Backbone.Events),c.getEventBus=function(){return f},_.extend(g.prototype,Backbone.History.prototype,{eventBus:f,loadUrl:function(a){var b=Backbone.History.prototype.loadUrl.apply(this,arguments),c=this.getFragment();return this.eventBus.trigger("historyChange",c),!0}}),c.History=g,c.history||(c.history=new g);var h={eventBus:c.getEventBus(),goTo:function(a){this.eventBus.trigger("placeChangeRequest",a)}};c.getPlaceController=function(){return h},i.prototype.test=function(a){var b=this.keys,c=this.params=[],d=this.regexp.exec(a);if(!d)return!1;for(var e=1,f=d.length;e<f;++e){var g=b[e-1],h="string"==typeof d[e]?decodeURIComponent(d[e]):d[e];g?c[g.name]=h:c.push(h)}return!0},i.prototype.extractParameters=function(a){return this.params},i.prototype.pathRegexp=function(a,b,c,d){return a instanceof RegExp?a:(Array.isArray(a)&&(a="("+a.join("|")+")"),a=a.concat(d?"":"/?").replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(a,c,d,e,f,g){return b.push({name:e,optional:!!g}),c=c||"",""+(g?"":c)+"(?:"+(g?c:"")+(d||"")+(f||d&&"([^/.]+?)"||"([^/]+?)")+")"+(g||"")}).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)"),new RegExp("^"+a+"$",c?"":"i"))},c.Route=i,_.extend(j.prototype,{pattern:null,initialize:function(){},getRoute:function(){var a,b=this.pattern;for(a in this.params)b=b.replace(":"+a,this.params[a]);return b},getParams:function(){return this.params},equals:function(a){return a instanceof this.constructor&&this._equalParams(a)?!0:!1},_equalParams:function(a){var b=a.getParams();return _.isEqual(b,this.params)}}),j.extend=c.helpers.extend,c.Place=j,_.extend(k.prototype,{placeController:c.getPlaceController(),eventBus:c.getEventBus(),initialize:function(a){},start:function(a){},stop:function(){},cancel:function(){},mayStop:function(){return!0},goTo:function(a){this.placeController.goTo(a)}}),k.extend=c.helpers.extend,c.Activity=k,_.extend(l.prototype,{test:function(a){var b,d;return a instanceof c.Place?a instanceof this.Place?!0:!1:(this.route=new c.Route(this.pattern),this.route.test(a))},buildPlace:function(a){var b;if(!this.route)throw new Error("place can only be built when the original place is a string");return b=this.route.extractParameters(a),new this.Place(b)}}),c.Match=l;var m=function(a){this.setElement(a)};_.extend(m.prototype,{display:function(b){this.close();if(b instanceof Backbone.View)b.render(),this.$el.html(b.el);else{if(!(b instanceof a||typeof b=="string"))throw new TypeError("DisplayRegion#show: invalid type for `view`.");this.$el.html(b)}},close:function(){this.$el.empty()},show:function(){this.$el.show()},hide:function(){this.$el.hide()},setElement:function(b){return this.$el=a(b),this.el=this.$el[0],this}}),m.extend=c.helpers.extend,c.DisplayRegion=m,_.extend(n.prototype,{eventBus:c.getEventBus(),register:function(a){var b=0,c;if(e(a)){c=a.length;for(;b<c;b++)this._register(a[b]);return}return this._register(a)},_register:function(a){var b=0,e,f,g,h;h=d(a),e=h.length;for(;b<e;b++)f=h[b],g=new c.Match(f,a),this._matchs.push(g)},_findMatch:function(a){var b,c,d,e;e=this._matchs;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.test(a))return b}return!1},_createPlace:function(a){var b=this._findMatch(a);return b instanceof c.Match?b.buildPlace(a):!1},reset:function(){this._displayRegion&&(this._displayRegion.close(),this._displayRegion.hide()),this._deactivateCurrentActivity(),this._currentActivity=null,this._currentPlace=null},load:function(a){var b,d=!0,e,f=c.helpers.resolvedPromise;return e=this._findMatch(a),e?(this._displayRegion.show(),a.equals(this._currentPlace)?f:(this._currentPlace=a,b=this._createActivity(e.Activity,a),this._deactivateCurrentActivity(),this._currentActivity=b,this._activate(b))):(this.reset(),this._displayRegion.hide(),f)},_createActivity:function(a,b){return new a(b)},_activate:function(b){var c=this,d=new o(this);return this._promise=d.getPromise(),this._startingNext=!0,a.when(this._promise).then(function(){c._startingNext=!1}),b.start(d),this._promise},_deactivateCurrentActivity:function(){this._deactivate(this._currentActivity)},_deactivate:function(a){var b=this;a&&(this._startingNext?a.cancel():a.stop())},mayStopCurrentActivity:function(){return!this._currentActivity||this._startingNext?!0:this._currentActivity.mayStop()},showView:function(a){this._displayRegion&&this._displayRegion.display(a)},getCurrentActivity:function(){return this._currentActivity},getCurrentPlace:function(){return this._currentPlace},getDisplayRegion:function(){return this._displayRegion}});var o=function(b){this.activity=b.getCurrentActivity(),this.activityManager=b,this.region=this.activityManager.getDisplayRegion(),this._deferred=a.Deferred(),this._promise=this._deferred.promise()};_.extend(o.prototype,{setView:function(a,b){var c=this.activityManager;this.activity==c.getCurrentActivity()&&(c.showView(a),(typeof b=="undefined"||b===!0)&&this._deferred.resolve(c._currentPlace))},getPromise:function(){return this._promise},finish:function(){this._deferred.resolve()},getRegion:function(){return this.activityManager.getDisplayRegion()}}),c.ActivityManager=n,c.ProtectedDisplay=o,_.extend(p.prototype,Backbone.Events,{eventBus:c.getEventBus(),_bindEvents:function(){this.eventBus.bind("placeChangeRequest",this._onPlaceChangeRequest,this),this.eventBus.bind("historyChange",this._onHistoryChange,this)},_unbindEvents:function(){this.eventBus.unbind("placeChangeRequest",this._onPlaceChangeRequest),this.eventBus.unbind("historyChange",this._onHistoryChange)},register:function(a){var b=0,c;if(e(a)){c=a.length;for(;b<c;b++)this._register(a[b])}else this._register(a)},_register:function(a){if(!(a instanceof c.ActivityManager))throw new Error("No valid ActivityManager.");this._managers.push(a)},_mayStop:function(){var a,b=this._managers.length,c;for(a=0;a<b;a++){c=this._managers[a];if(!c.mayStop())return!1}return!0},_onHistoryChange:function(a){var b=this._createPlace(a);if(!(b instanceof c.Place)){this.trigger("placeNotFound",a);return}this._currentPlace=b,this._triggerPlaceChange(b)},_onPlaceChangeRequest:function(a){if(!this._mayLoadPlace(a))return;this._triggerPlaceChange(a),this._navigate(a)},_mayLoadPlace:function(a){var b=this,c,d=this._managers.length,e;if(a.equals(this._currentPlace))return!1;for(c=0;c<d;c++){e=this._managers[c];if(!e.mayStopCurrentActivity())return!1}return!0},_triggerPlaceChange:function(a){var b=this;this.trigger("beforePlaceChange",a),this._loadManagers(a,function(){b.trigger("placeChange",a)})},_loadManagers:function(b,c){var d,e=this._managers.length,f,g,h=[];for(d=0;d<e;d++)f=this._managers[d],g=f.load(b),h.push(g);a.when.apply(null,h).then(c)},_navigate:function(a){this._currentPlace=a,c.history.navigate(a.getRoute(),{navigate:!1})},getCurrentPlace:function(){return this._currentPlace},_createPlace:function(a){var b,c=this._managers.length,d,e;for(b=0;b<c;b++){d=this._managers[b],e=d._createPlace(a);if(e)break}return e}}),c.Application=p}).call(this,this.jQuery||this.Zepto);