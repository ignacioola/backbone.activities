(function(e){function o(){return Backbone.History.apply(this,arguments)}function a(e,t){t=t||{},this.path=e,this.params={},this.regexp=this.pathRegexp(e,this.keys=[],t.sensitive,t.strict)}function f(e){this.params=e||{},this.initialize.apply(this,arguments)}function l(e){this.currentPlace=e,this.initialize.apply(this,arguments)}function c(e,t){this.Place=e,this.Activity=t,this.pattern=e.prototype.pattern}function p(e){this._displayRegion=e,this._matchs=[]}function v(){this._managers=[],this._bindEvents()}var t=this,n;typeof exports!="undefined"?n=exports:n=t.activities={},n.VERSION="0.3.0",!e&&typeof require!="undefined"&&(t.jQuery=e=require("jquery")),!t.Backbone&&typeof require!="undefined"&&(t.Backbone=require("backbone")),!t._&&typeof require!="undefined"&&(t._=require("underscore")._),t.Backbone.activities=n,n.helpers={};var r=function(e){var t=e.prototype.place;if(!t)throw new Error("Activity must have a `place` property");return _.isArray(t)?t:[t]},i=function(e){return _.isArray(e)};n.helpers.extend=Backbone.View.extend,n.helpers.getPlaces=r,n.helpers.resolvedPromise=null;var s={};_.extend(s,Backbone.Events),n.getEventBus=function(){return s},_.extend(o.prototype,Backbone.History.prototype,{eventBus:s,loadUrl:function(e){var t=Backbone.History.prototype.loadUrl.apply(this,arguments),n=this.getFragment();return this.eventBus.trigger("historyChange",n),!0}}),n.History=o,n.history||(n.history=new o);var u={eventBus:n.getEventBus(),goTo:function(e){this.eventBus.trigger("placeChangeRequest",e)}};n.getPlaceController=function(){return u},a.prototype.test=function(e){var t=this.keys,n=this.params=[],r=this.regexp.exec(e);if(!r)return!1;for(var i=1,s=r.length;i<s;++i){var o=t[i-1],u="string"==typeof r[i]?decodeURIComponent(r[i]):r[i];o?n[o.name]=u:n.push(u)}return!0},a.prototype.extractParameters=function(e){return this.params},a.prototype.pathRegexp=function(e,t,n,r){return e instanceof RegExp?e:(Array.isArray(e)&&(e="("+e.join("|")+")"),e=e.concat(r?"":"/?").replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(e,n,r,i,s,o){return t.push({name:i,optional:!!o}),n=n||"",""+(o?"":n)+"(?:"+(o?n:"")+(r||"")+(s||r&&"([^/.]+?)"||"([^/]+?)")+")"+(o||"")}).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)"),new RegExp("^"+e+"$",n?"":"i"))},n.Route=a,_.extend(f.prototype,{pattern:null,initialize:function(){},getRoute:function(){var e,t=this.pattern;for(e in this.params)t=t.replace(":"+e,this.params[e]);return t},getParams:function(){return this.params},equals:function(e){return e instanceof this.constructor&&this._equalParams(e)?!0:!1},_equalParams:function(e){var t=e.getParams();return _.isEqual(t,this.params)}}),f.extend=n.helpers.extend,n.Place=f,_.extend(l.prototype,{placeController:n.getPlaceController(),eventBus:n.getEventBus(),initialize:function(e){},start:function(e){},stop:function(){},cancel:function(){},mayStop:function(){return!0},goTo:function(e){this.placeController.goTo(e)}}),l.extend=n.helpers.extend,n.Activity=l,_.extend(c.prototype,{test:function(e){var t,r;return e instanceof n.Place?e instanceof this.Place?!0:!1:(this.route=new n.Route(this.pattern),this.route.test(e))},buildPlace:function(e){var t;if(!this.route)throw new Error("place can only be built when the original place is a string");return t=this.route.extractParameters(e),new this.Place(t)}}),n.Match=c;var h=function(e){this.setElement(e)};_.extend(h.prototype,{show:function(t){this.close();if(t instanceof Backbone.View)t.render(),this.$el.html(t.el);else{if(!(t instanceof e||typeof t=="string"))throw new TypeError("DisplayRegion#show: invalid type for `view`.");this.$el.html(t)}},close:function(){this.$el.empty()},setElement:function(t){return this.$el=e(t),this.el=this.$el[0],this}}),h.extend=n.helpers.extend,n.DisplayRegion=h,_.extend(p.prototype,{eventBus:n.getEventBus(),register:function(e){var t=0,n;if(i(e)){n=e.length;for(;t<n;t++)this._register(e[t]);return}return this._register(e)},_register:function(e){var t=0,i,s,o,u;u=r(e),i=u.length;for(;t<i;t++)s=u[t],o=new n.Match(s,e),this._matchs.push(o)},_findMatch:function(e){var t,n,r,i;i=this._matchs;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.test(e))return t}return!1},_createPlace:function(e){var t=this._findMatch(e);return t instanceof n.Match?t.buildPlace(e):!1},reset:function(){this._displayRegion&&this._displayRegion.close(),this._currentActivity=null,this._currentPlace=null},load:function(e){var t,r=!0,i,s=n.helpers.resolvedPromise;return i=this._findMatch(e),i?e.equals(this._currentPlace)?s:(this._currentPlace=e,t=this._createActivity(i.Activity,e),this._deactivate(this._currentActivity),this._currentActivity=t,this._activate(t)):(this.reset(),s)},_createActivity:function(e,t){return new e(t)},_activate:function(t){var n=this,r=new d(this);return this._promise=r.getPromise(),this._startingNext=!0,e.when(this._promise).then(function(){n._startingNext=!1}),t.start(r),this._promise},_deactivate:function(e){var t=this;e&&(this._startingNext?e.cancel():e.stop())},mayStopCurrentActivity:function(){return!this._currentActivity||this._startingNext?!0:this._currentActivity.mayStop()},showView:function(e){this._displayRegion&&this._displayRegion.show(e)},getCurrentActivity:function(){return this._currentActivity},getCurrentPlace:function(){return this._currentPlace},getDisplayRegion:function(){return this._displayRegion}});var d=function(t){this.activity=t.getCurrentActivity(),this.activityManager=t,this._deferred=e.Deferred(),this._promise=this._deferred.promise()};_.extend(d.prototype,{setView:function(e){var t=this.activityManager;this.activity==t.getCurrentActivity()&&(t.showView(e),this._deferred.resolve(t._currentPlace))},getPromise:function(){return this._promise},finish:function(){this._deferred.resolve()}}),n.ActivityManager=p,n.ProtectedDisplay=d,_.extend(v.prototype,Backbone.Events,{eventBus:n.getEventBus(),_bindEvents:function(){this.eventBus.bind("placeChangeRequest",this._onPlaceChangeRequest,this),this.eventBus.bind("historyChange",this._onHistoryChange,this)},_unbindEvents:function(){this.eventBus.unbind("placeChangeRequest",this._onPlaceChangeRequest),this.eventBus.unbind("historyChange",this._onHistoryChange)},register:function(e){this._managers.push(e)},_mayStop:function(){var e,t=this._managers.length,n;for(e=0;e<t;e++){n=this._managers[e];if(!n.mayStop())return!1}return!0},_onHistoryChange:function(e){var t=this._createPlace(e);if(!(t instanceof n.Place)){this.trigger("placeNotFound",e);return}this._currentPlace=t,this._triggerPlaceChange(t)},_onPlaceChangeRequest:function(e){if(!this._mayLoadPlace(e))return;this._triggerPlaceChange(e),this._navigate(e)},_mayLoadPlace:function(e){var t=this,n,r=this._managers.length,i;if(e.equals(this._currentPlace))return!1;for(n=0;n<r;n++){i=this._managers[n];if(!i.mayStopCurrentActivity())return!1}return!0},_triggerPlaceChange:function(e){var t=this;this.trigger("beforePlaceChange"),this._loadManagers(e,function(){t.trigger("placeChange",e)})},_loadManagers:function(t,n){var r,i=this._managers.length,s,o,u=[];for(r=0;r<i;r++)s=this._managers[r],o=s.load(t),u.push(o);e.when.apply(null,u).then(n)},_navigate:function(e){this._currentPlace=e,n.history.navigate(e.getRoute(),{navigate:!1})},getCurrentPlace:function(){return this._currentPlace},_createPlace:function(e){var t,n=this._managers.length,r,i;for(t=0;t<n;t++){r=this._managers[t],i=r._createPlace(e);if(i)break}return i}}),n.Application=v}).call(this,this.jQuery||this.Zepto);